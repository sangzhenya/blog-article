## MyBaits 全局配置

MyBaits 是一个半自动化的持久化层框架，支持定制化 SQL，存储过程以及高级映射。避免 JDBC 代码和手动设置参数以及获取结果集。其使用简单的 XML 或注解用于配置和原始映射，将接口和 Java 的对象映射成数据库记录。

![MyBaits 处理流程](http://img.sangzhenya.com/20191224220407.png)

一个简单的项目配置如下：

`pom.xml` 配置如下：

```xml
<dependencies>
  <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
  <dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis</artifactId>
    <version>3.5.3</version>
  </dependency>
  <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
  <dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.18</version>
  </dependency>
  <!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api -->
  <dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter-api</artifactId>
    <version>5.6.0-M1</version>
    <scope>test</scope>
  </dependency>
</dependencies>
```

首先创建一个 User 对象：

```java
public class User {
    private Integer id;
    private String name;
    private String password;
    private String lastName;
    private String firstName;
    // ... getter/setter
    // toString
}
```

然后创建一个 Mapper 接口

```java
public interface UserMapper {
    User getUserById(Integer id);
}
```

在 resource 目录下添加配置文件 `UserMapper.xml` 

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xinyue.imybatis.mapper.UserMapper">
  <!-- namespace:名称空间;指定为接口的全类名 -->

  <!-- 对应方法是：User getUserById(Integer id); -->
  <!-- id：唯一标识; resultType：返回值类型; #{id}：从传递过来的参数中取出id值 -->
  <select id="getUserById" resultType="com.xinyue.imybatis.model.User">
		select id, name, password, first_name firstName, last_name lastName from user where id = #{id}
	</select>
</mapper>
```

在 resource 目录下添加配置文件 `mybatis-config.xml`

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <!-- 多环境配置 -->
        <environment id="development">
            <!-- 配置 JDBC TransactionManager -->
            <transactionManager type="JDBC" />
            <!-- 配置 Data Source -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver" />
                <property name="url" value="jdbc:mysql://localhost:3306/xinyue" />
                <property name="username" value="root" />
                <property name="password" value="123456" />
            </dataSource>
        </environment>
    </environments>
  	<!-- 所有的 Mapper 放在下面 -->
    <mappers>
        <mapper resource="UserMapper.xml" />
    </mappers>
</configuration>
```

测试方法如下：

```java
public SqlSessionFactory getSqlSessionFactory() throws IOException {
  String resource = "mybatis-config.xml";
  InputStream inputStream = Resources.getResourceAsStream(resource);
  return new SqlSessionFactoryBuilder().build(inputStream);
}


@Test
public void test() {
  // 1、根据配置文件获取 sqlSessionFactory 对象
  try {
    SqlSessionFactory sqlSessionFactory = getSqlSessionFactory();
    // 2、使用 sqlSessionFactory 获取 sqlSession 对象
    // sqlSession 不是线程安全的，所以每次使用都必须重新获取且使用完毕之后需要正确关闭
    try (SqlSession openSession = sqlSessionFactory.openSession()) {
      // 3、MyBatis 为接口自动的创建一个代理对象，代理对象去执行增删改查方法
      UserMapper mapper = openSession.getMapper(UserMapper.class);
      User user = mapper.getUserById(1);
      System.out.println(mapper.getClass());
      System.out.println(user);
    }
  } catch (IOException e) {
    e.printStackTrace();
  }
}
```



