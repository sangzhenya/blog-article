## Ribbon Feign Hystrix Zuul

### Ribbon

Spring Cloud Ribbon 是基于 Netflix Ribbon 实现一套客户端负载均衡的工具。Ribbon 是 Netflix 发布的开源项目，其主要功能是提供客户端的负载均衡算法，将 Netflix 的中间层服务连接在一起。Ribbon 客户端组件提供了一系列完善的配置项如连接超时，重试等。简单的说就是在配置文件中列出 Load Balancer 后面所有的服务，Ribbon 会自动的基于某种规则，例如轮询，随机等算法去连接这些服务。当然也容易使用 Ribbon 实现自定义的负载均衡算法。

负载均衡算法分为两种一种是进程外的：例如 F5 硬件负载均衡，Nginx 软件负载均衡。一种是进程内的其实将Load Balancer 的逻辑集成到了消费方，消费方从服务注册中心获知哪些地址可用，然后从这些地址中选择一个合适的服务器。Ribbon 就属于进程内的 Load Balancer。

Ribbon 的核心组件是 IRule，是根据特定的算法从服务列表中选取一个要访问的服务。默认有 1. 

1. RoundRobinRule：轮询
2. RandomRule：随机
3. AvailabilityFilteringRule：先过滤掉由于多次访问故障而处于断路器跳闸状态的服务及并发的连接数量超过阈值的服务，然后对剩余的服务列表按照轮询的策略进行访问。
4. WeightedResponseTimeRule：根据平均响应时间计算所有服务的权重，响应时间越快服务权重越大的被选中概率越高，刚启动时如果统计信息不足则使用轮询的策略直到统计信息足够才会切换回来。
5. RetryRule：按照轮询策略获取服务，如果获取服务失败则在指定时间内重试获取可用服务。
6. BestAvailableRule：会过滤掉由于多次访问故障处于断路器跳闸状态的服务，然后选择一个并发量最小的服务。
7. ZoneAvoidanceRule：默认规则，符合判断 Server 所有区域性能和 Server 可用性选择服务器。

### Feign

是一个声明式 WebService 客户端，使用 Feign 能让编写 Web Service 客户端更加简单。其就是定义一个接口，然后再上面加上注解，同时其也支持 JAX-RS 标准的注解，Feign 也支持可插拔式的编码和解码器。Spring Cloud 对 Feign 进行了封装，使其支持了 Spring MVC 标准的注解和 HttpMessageConverters。 Feign 可以与 Eureka 和 Ribbon 组合使用以支持负载均衡。

### Hystrix

在分布式系统中程序可能有数十个依赖关系，每个依赖关系在某些时候将不可以避免不能用，这就有可能导致服务雪崩，即多个微服务之间调用的时候，假设微服务 A调用微服务 B和 C，B 和 C 又调用其他服务，即 **扇出**。如果删除的链路上某个微服务的调用相应时间过长或者不可用，对服务 A 的调用就会占用越来越多的资源，进而引起系统崩溃，也就是雪崩效应。

对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源在几秒钟内饱和。比失败更糟糕的是这些应用程序可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生级联故障。也就说必须对故障和延迟进行隔离和管理，以便单个依赖关系的失败不影响整个系统。

Hystrix 是一个用于处理分布式系统延迟和出错的开源库，其能够保证在一个依赖出错的情况下，不会导致整个服务失败，避免级联故障，进而提高分布式系统的弹性。断路器本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控，想调用方返回一个服务预期的，可以处理的备选响应（FallBack)，而不是长时间的等待或者抛出调用方法无法处理的异常，这样就能保证了调用方的线程不会长时间不必要的占用，从而避免了故障在分布式系统的蔓延，乃至雪崩。

#### 服务熔断

服务熔断是应对雪崩的一种微服务链路保护机制，当扇出链路的某个微服务不可用或者响应时间太长的时候，会进行服务降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。当见到该节点微服务调用响应正常后恢复调用链路。在 Spring Cloud 中通过 Hystrix 实现熔断机制。其会监控服务间的调用状况，当失败的调用到一定的阈值的时候，默认是 5秒内20次调用失败的时候就会触发熔断机制。

#### 服务降级

服务降级即在服务资源不够的情况下将某些服务先关掉，等待资源充足的时候再启动。服务降级在客户端完成，与服务端没有关系。客户端的服务端不可用的时候获得提示信息，而不会挂起服务器。

#### Hystrix Dashboard

Hystrix 会持续地记录所有通过 Hystrix 的请求执行信息，并以统计报表和图形的形势展示给用户，包括每秒执行多少请求成功，多少请求失败等。Spring Cloud 也提供了 Hystrix Dashboard 的整合对监控的内容转化成可视化界面。界面如下：

![监控界面](http://img.programya.com/20200111184406.png)

七个颜色的数字从上到下，从左到右分别代表：Success，Short-Circuited，Bad Request，Timeout，Rejected，Rejected，Error 百分数数量。实心圆有两种含义，通过颜色的变化表示实例的健康状态，健康度依次是  绿色，黄色，橙色，红色。通过大小变化反应请求流量的状态，流量越大实心圆越大。

Host 服务请求的频率，Circuit 表示断路的状态。Hosts 表示集群主机状态的报告，后面显示 1最近一分钟百分位延迟统计。

### Zuul

Zuul 包含了对请求的路由和过滤的功能。其中路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础而过滤功能则负载将对请求的处理过程进行干预，实现对请求校验，服务聚合等功能的基础。Zuul 可以和 Eureka 集成，注册进 Eureka，从 Eureka 获取其他微服务的信息，之后访问微服务可以从 Zuul 获得。通过 Zuul 访问的 URL 如 `http://zuulgateway:9001/iboot-provider/` 。