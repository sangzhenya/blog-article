## 嵌入式容器

### 对于嵌入式容器的配置

Spring 的基本的 Server 的配置都可以在 `application.yaml` 中通过 `server` 相关的属性进行配置。

![Server 相关的配置](http://img.sangzhenya.com/Snipaste_2019-12-16_23-11-06.png)

其对应的配置类是 

```java
@ConfigurationProperties(prefix = "server", ignoreUnknownFields = true)
public class ServerProperties {
  private final Tomcat tomcat = new Tomcat();
  
  public static class Tomcat {
		private final Accesslog accesslog = new Accesslog();
		private String protocolHeader;
		private String protocolHeaderHttpsValue = "https";
		private String portHeader = "X-Forwarded-Port";
  }
}
```

其内部类 `Tomcat` 用户配置 `Tomcat` 相关的信息。在 `ServletWebServerFactoryCustomizer` 会使用 其中的配置对 嵌入式容器进行配置， 同样也可以通过使用 `WebServerFactoryCustomizer` 去配置嵌入式容器，例如如下：

```java
@Configuration
public class MvcConfig implements WebMvcConfigurer {
    @Bean
    public WebServerFactoryCustomizer<ConfigurableWebServerFactory> customizer() {
        return factory -> factory.setPort(8081);
    }
}
```

### 在嵌入式容器中使用 Web 三大组件

#### Servlet

可以使用 `ServletRegistrationBean` 进行注册。

```java
public class MyServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        resp.getWriter().write("Hello World");
    }
}

@Bean
public ServletRegistrationBean<MyServlet> myServlet() {
  ServletRegistrationBean<MyServlet> servletRegistrationBean = new ServletRegistrationBean<>(new MyServlet(), "/servlet");
  servletRegistrationBean.setLoadOnStartup(1);
  return servletRegistrationBean;
}
```



#### Filter

可以使用 `FilterRegistrationBean` 进行注册。

```java
public class MyFilter extends HttpFilter {
    private Log log = LogFactory.getLog(MyFilter.class);
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        log.info("My Filter Processed...");
        chain.doFilter(request, response);
    }
}

@Bean
public FilterRegistrationBean<MyFilter> myFilter() {
  FilterRegistrationBean<MyFilter> filterFilterRegistrationBean = new FilterRegistrationBean<>();
  filterFilterRegistrationBean.setFilter(new MyFilter());
  filterFilterRegistrationBean.setUrlPatterns(Collections.singletonList("/servlet"));
  return filterFilterRegistrationBean;
}
```



#### Listener

可以使用 `ServletListenerRegistrationBean` 注册。

```java
public class MyListener implements ServletContextListener {
    private Log log = LogFactory.getLog(MyListener.class);
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        log.info("Servlet Context Inited");
    }
    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        log.info("Servlet Context Destroyed");
    }
}

@Bean
public ServletListenerRegistrationBean<MyListener> myListener() {
  return new ServletListenerRegistrationBean<>(new MyListener());
}
```

SpringBoot 在自动注册 Spring MVC 的时候会自动注册 `DispatcherServlet`。使用 `DispatcherServletAutoConfiguration` 进行注册。

```java
public static final String DEFAULT_DISPATCHER_SERVLET_BEAN_NAME = "dispatcherServlet";

@Configuration(proxyBeanMethods = false)
@Conditional(DispatcherServletRegistrationCondition.class)
@ConditionalOnClass(ServletRegistration.class)
@EnableConfigurationProperties(WebMvcProperties.class)
@Import(DispatcherServletConfiguration.class)
protected static class DispatcherServletRegistrationConfiguration {

  @Bean(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)
  @ConditionalOnBean(value = DispatcherServlet.class, name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)
  public DispatcherServletRegistrationBean dispatcherServletRegistration(DispatcherServlet dispatcherServlet,
                                                                         WebMvcProperties webMvcProperties, ObjectProvider<MultipartConfigElement> multipartConfig) {
    DispatcherServletRegistrationBean registration = new DispatcherServletRegistrationBean(dispatcherServlet,
                                                                                           webMvcProperties.getServlet().getPath());
    registration.setName(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);
    registration.setLoadOnStartup(webMvcProperties.getServlet().getLoadOnStartup());
    multipartConfig.ifAvailable(registration::setMultipartConfig);
    return registration;
  }

}
```



### 切换嵌入式容器

在 Spring Boot 中除了支持 Tomcat 之外也支持 Jetty 和 Undertow 等另外两种 Servlet 容器。其中 Jetty 更适合于长链接的应用，而 Undertow 更适合于高并发的应用。

例如必须想要使用 Undertow 代替默认的 Tomcat 容器，首先在 pom 文件中去除 Tomcat 的依赖，然后加入 Undertow 的依赖即可。

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
  <exclusions>
    <exclusion>
      <artifactId>spring-boot-starter-tomcat</artifactId>
      <groupId>org.springframework.boot</groupId>
    </exclusion>
  </exclusions>
</dependency>

<dependency>
  <artifactId>spring-boot-starter-undertow</artifactId>
  <groupId>org.springframework.boot</groupId>
</dependency>
```

#### 嵌入式 Servlet 容器自动配置原理

#### 嵌入式 Servlet 容器启动原理



