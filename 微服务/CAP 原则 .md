## ACID 原则 与 CAP 原则

[TOC]

### **ACID 原则**

1. A (Atomicity) 原子性

   原子性即事务里的所有操作要么全部做完，要么都不做。事务成功的条件就是事务里所有操作都成功，任意一个事务失败，则整个事务就是失败，需要回滚。

2. C (Consistency) 一致性

   一致性即数据库要一直处于一致状态，事务的运行不会改变数据库原本的一致性约束。

3. I (Isolation) 独立性

   独立性即并发的事务之间不会相互影响，如果一个事务要访问的数据正在被另外一个事务修改，只要另外一个事务未提交，它访问的数据就不受未提交事务的影响。

4. D (Duarbility) 持久性

   持久性即一旦事务提交后，它做的修改将会永远保存在数据库上，即使出现宕机也不会丢失。



### **CAP 原则**

1. C (Consistency) 强一致性
2. A (Availability) 可用性
3. P (Partition tolerance) 区域容错性

CAP 如下图所示：

![经典 CAP 图](https://i.loli.net/2019/06/19/5d0a19bdd624668869.png)

CAP 理论的核心是一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性三个需求，因此 根据 CAP 原理可以将 NoSQL 数据库分成了满足 CA 原则、满足 CP 原则和满足 AP 原则的三大类。

CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。

CP - 满足一致性，分区容错性，通常性能不是特别高。

AP - 满足可用性，分区容错性，通常可能对一致性要求低一些。



上述提到的 CAP 理论表明分布式存储系统中，最多只能实现上面的两点。而由于当前的网络硬件肯定会出现延迟丢包的问题。也就是说分区容错性是必须要实现的，所以只能在一致性和可用性之间进行权衡。



### **Eureka 和 Zookeeper 比较**：

1. Zookeeper 保证 CP

   当想注册中心查询服务列表时，需要忍受注册中心返回的是几分钟以前的注册信息，但不能接受服务直接不可用。即服务注册功能对可用性要去高于一致性。但是 ZK 会出现这样的情况，当 mater 节点因为网络故障与其他节点失去联系的时，剩余的节点会重新进行 leader 选举。但是选举 leader 的时间过长， 30 ~ 120s 且选举期间整个 zk 集群都是不可用的，这样会导致选举期间注册服务瘫痪。在云部署的环境下，因网络问题使得 zk 集群失去 mater 节点的是大概率发生的事情，虽然服务能够最终恢复，但是漫长的选举时间导致注册长期不可用是无法忍受的。

2. Eureka 保证 AP

   Eureka 设计优先保证可用性。Eureka 的各个节点都是平等的，几个节点挂断不会影响正常节点的工作，剩余的节点仍旧可以提供注册和查询服务。而 Eureka 的客户端向某个 Eureka 的注册时如果发现连接失败，则自动切换至其他节点，只要有一台 Eureka 还在，就可以保证注册服务的可用性。只不过查询到的信息可能不是最新的。此处之外， Eureka 还有一种自我保护机制，如果 15 内超过 85% 的节点都没有正常心跳，那么 Eureka 就认为客户端与注册中心出现了网络故障，此时会出现一下几种情况：

   1. Eureka 不再从注册列表中移除因长时间没有收到心跳而应该过期的服务。
   2. Eureka 仍然能够接受新服务注册和查询，但是不能被同步到其他节点上。
   3. 当网络稳定时，当前示例新的注册信息会被同步到其他节点上。

   所以 Eureka 可以很好的应对因为网络故障导致部分节点失去联系的情况，而不会像 zookeeper 那样整个注册服务瘫痪。